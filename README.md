# استقرار n8n روی Koyeb با PostgreSQL خارجی

این مخزن قالبی برای استقرار **n8n** روی Koyeb (پلن رایگان) با پایگاه‌داده PostgreSQL خارجی است. دیپلوی از طریق اتصال مستقیم Koyeb به GitHub انجام می‌شود و یک GitHub Actions زمان‌بندی‌شده، هر ۱۵ دقیقه یکبار به سرویس درخواست می‌زند تا در پلن رایگان به خواب نرود.

## پیش‌نیازها

- اکانت Koyeb با دسترسی به پلن رایگان یا بالاتر.
- مخزن GitHub که این پروژه در آن پوش می‌شود.
- پایگاه‌داده PostgreSQL مدیریت‌شده (مانند Neon، Supabase، Render، Railway و …).
- دامنه `*.koyeb.app` یا دامنه سفارشی (اختیاری) برای دسترسی به رابط وب n8n.

## فایل‌ها و ساختار

- `Dockerfile`: استفاده از ایمیج رسمی `n8nio/n8n` با نسخه پین شده. در صورت نیاز می‌توانید ابزار یا وابستگی‌های اضافی را اضافه کنید.
- `.env.example`: قالب متغیرهای محیطی که باید در Koyeb تنظیم شوند.
- `.github/workflows/keepalive.yml`: وظیفهٔ GitHub Actions که سرویس را بیدار نگه می‌دارد.

## راه‌اندازی

1. این پروژه را فورک یا کلون کرده و در مخزن GitHub خود قرار دهید.
2. فایل `.env.example` را باز کرده و مقادیر را با توجه به اطلاعات PostgreSQL و دامنهٔ خود تکمیل کنید. (در GitHub نگهداری نشود؛ فقط برای راهنما است.)
3. در داشبورد Koyeb:
   1. روی **Create Web Service** کلیک کنید، **GitHub** را انتخاب کنید و مخزن را انتخاب نمایید.
   2. در بخش **Builder**، گزینهٔ **Dockerfile** را انتخاب کنید (مسیر پیش‌فرض ریشهٔ مخزن است).
   3. در قسمت **Environment Variables**، متغیرهای موجود در `.env.example` را اضافه کنید.
      - مقادیر PostgreSQL باید با دیتابیس بیرونی شما مطابقت داشته باشد.
      - `N8N_ENCRYPTION_KEY` را یک رشتهٔ تصادفی طولانی انتخاب کنید.
      - برای فعال کردن Basic Auth، نام کاربری و رمز قوی انتخاب کنید.
   4. سرویس را در یک منطقه‌ای (مانند `was`) مستقر کنید و در صورت نیاز Volume متصل کنید (برای این سناریو الزامی نیست چون داده‌ها در PostgreSQL ذخیره می‌شوند).
4. پس از دیپلوی اولیه، URL سرویس را در خروجی Koyeb پیدا کنید. از طریق HTTPS به رابط وب n8n دسترسی خواهید داشت.

## فعال‌سازی سیستم Keep-Alive

در پلن رایگان Koyeb، سرویس بعد از مدتی عدم استفاده به خواب می‌رود. فایل `keepalive.yml` یک GitHub Actions زمان‌بندی‌شده است که هر ۱۵ دقیقه درخواست `GET` به سرویس می‌فرستد تا فعال بماند.

1. در مخزن GitHub، به **Settings → Secrets and variables → Actions** بروید.
2. یک Secret با نام `PING_URL` ایجاد کنید و مقدار آن را برابر آدرس HTTPS سرویس قرار دهید (مثلاً `https://my-n8n.koyeb.app/`).
3. اکشن به صورت خودکار اجرا شده و هر ۱۵ دقیقه سرویس را پینگ می‌کند. در صورت تمایل می‌توانید بازهٔ زمانی را در فایل Workflow تغییر دهید.

> **نکته:** برای جلوگیری از مصرف بی‌رویهٔ منابع یا درخواست‌های ناخواسته، مسیر مشخصی (مثلاً `/healthz`) تعریف کنید و آن را در n8n بسازید، سپس همان مسیر را در `PING_URL` قرار دهید.

## متغیرهای محیطی کلیدی

متغیرها در `.env.example` مستند شده‌اند، اما مهم‌ترین‌ها عبارتند از:

- `DB_TYPE`, `DB_POSTGRESDB_HOST`, `DB_POSTGRESDB_PORT`, `DB_POSTGRESDB_DATABASE`, `DB_POSTGRESDB_USER`, `DB_POSTGRESDB_PASSWORD`: اتصال به PostgreSQL خارجی.
- `N8N_HOST`, `N8N_PROTOCOL`, `N8N_PORT`, `WEBHOOK_URL`: تنظیمات URL عمومی که Koyeb ارائه می‌دهد.
- `N8N_ENCRYPTION_KEY`: رمزگذاری Credentialها در پایگاه‌داده.
- `N8N_BASIC_AUTH_ACTIVE`, `N8N_BASIC_AUTH_USER`, `N8N_BASIC_AUTH_PASSWORD`: محافظت از رابط وب با احراز هویت ساده.

## گسترش‌های پیشنهادی

- استفاده از Redis و Queue Mode برای بار زیاد.
- اتصال دامنهٔ اختصاصی و فعال‌سازی HTTPS از طریق Koyeb یا سرویس DNS شما.
- افزودن پشتیبانی از Volume در صورت نیاز به فایل‌های محلی یا اجرای کد سفارشی در مسیر `~/.n8n`.

---

برای سوالات یا بهبودها، Issue باز کنید یا Pull Request بفرستید.
